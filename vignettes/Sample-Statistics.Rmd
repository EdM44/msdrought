---
title: "Sample-Statistics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Sample-Statistics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)


```

```{r setup}
library(MSD)
```

The purpose of the MSD package is to take the input of a series of rainfall data and to extract some key information (such as dates, rainfall intensity, duration of a rainfall period, and more) to characterize the Mid-Summer Drought climatic phenomenon present in Central America. This vignette will walk you through the process of taking a raster input and extracting a relevant statistic for the entire timeseries of the provided data.

We will begin by loading in the relevant packages and the raster data we plan to use. In order to get this data to function with the MSD package's functions, we'll need to extract a single point of spatial data in the form of a timeseries. This will be done using the "terra" package. The "tidyr" package will be useful for streamlining the code. If the data you plan to analyze is in the form of a timeseries (TS), you only need to load the package and proceed to the next step.

```{r}
library(MSD)
library(terra)
library(tidyr)
data("raster") #This loads the data included in the package, but you would attach your own

# Extract 1 spatial point from the raster data
infile = raster
lon = -86.2621555581 #Longitude of the spatial point we're interested in analyzing
lat = 13.3816217871 #Lattitude of the spatial point we're interested in analyzing
lonLat = data.frame(lon=lon,lat=lat)

# Set up precipitation data by extracting the data located at our longitude and lattitude
location = vect(lonLat, crs = "+proj=longlat +datum=WGS84")
precip = terra::extract(infile, location, method = 'bilinear') %>%
  subset(select = -ID) %>%
  t()
precip[precip < 0] <- 0 #replace any negative (errant) values with zeroes
precipFrame = data.frame(precip)

# Set up dates (time) data which will be used in creating our time series
timeFrame = terra::time(infile) %>%
  as.Date() %>%
  data.frame()
startDate = as.Date(as.character(timeFrame[1,1]))
endDate = as.Date(as.character(timeFrame[nrow(timeFrame),1]))
datesSequence = seq(from = startDate, to = endDate, by = 1)
timeseriesFrame = cbind(timeFrame, precipFrame)
colnames(timeseriesFrame) = c("Date", "Precipitation")

# Make the data into a timeseries that the package recognizes
x = xts(timeseriesFrame$Precipitation, timeseriesFrame$Date)
```

At this point, we taken a raster of data and extracted from it a series of precipitation values and a series of time for a single location. This data can now be used with the MSD package and its functions.

Now, we will calculate a relevant statistic for this set of data. There are several options included in the package, but for the purpose of demonstration, we will find the **intensity.**

Before we calculate the intensity, however, we will need to read some critical pieces of info from our timeseries.

```{r}
# Use the msdDates function to extract the key dates related to the window of the MSD
# msdDates = msdDates(x, firstStartDate, firstEndDate, secondStartDate, secondEndDate)
keyDatesTS = msdDates(time(x))
# Note: The windows (between the start and end dates) can be user-defined, but leaving the field blank uses the parameters determined by the founders of this package

# Filter the data using a bartlett noise filter by using the msdFilter function
# msdFilter = msdFilter(x, window)
filterTS1 = apply(x, MARGIN = 2, FUN = msdFilter, window = 31)
filterTS2 = apply(filterTS1, MARGIN = 2, FUN = msdFilter, window = 31)
# Note: The founders of this package recommend filtering the data twice, but this is left up to the user to decide
```

Now that we have the key dates and a filtered timeseries, it is time to calculate the **intensity.** We will see an output of 1 value per year of data. Because the timeseries we've created from the raster is for 5 years of data (from 1981 to 1985) we will see 5 intensity values.

```{r}
# Use msdStats and r's built-in apply function to apply the intensity calculation across the filtered timeseries data
# msdStats = msdStats(x, dates, fcn)
duration <- apply(filterTS2, MARGIN = 2, FUN = msdStats, keyDatesTS, fcn="intensity")
```
